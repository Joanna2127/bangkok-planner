<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>曼谷六天五夜 11/18-11/23</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-bg': '#F9F9F4',       
                        'jp-yellow': '#F3E5AB',   
                        'jp-yellow-dark': '#E6D284',
                        'jp-text': '#454545',     
                        'jp-gray': '#9E9E9E',     
                        'jp-accent': '#D4A373',
                        'jp-red': '#E07A5F',
                        'jp-blue': '#4A90E2',
                        'bts-green': '#65B32E',
                        'mrt-blue': '#1A568F',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        serif: ['"Noto Serif TC"', 'serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 2px 10px rgba(0, 0, 0, 0.03)',
                        'float': '0 10px 30px rgba(0, 0, 0, 0.1)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #E5E5E5;
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        #app-container {
            max-width: 480px;
            margin: 0 auto;
            background-color: #F9F9F4;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 10px; font-family: 'Noto Sans TC', sans-serif; font-size: 13px; color: #454545; }
        
        .sortable-ghost { opacity: 0.4; background: #F3E5AB; }
        .sortable-drag { cursor: grabbing; }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
    </style>
</head>
<body>

<div id="app">
    <div id="app-container">
        
        <!-- Header -->
        <header class="bg-jp-bg pt-6 pb-2 px-4 sticky top-0 z-20 border-b border-gray-100 shadow-sm">
            <!-- Top Row: Title, Weather, Tools -->
            <div class="flex justify-between items-start mb-4">
                <div @click="editTitle" class="flex-1">
                    <h1 class="text-2xl font-serif font-bold text-jp-text tracking-wide leading-tight">{{ tripTitle }}</h1>
                    <p class="text-xs text-jp-gray tracking-wider mt-1">11/18 - 11/23 ({{ tripDays }} 天)</p>
                </div>
                
                <div class="flex items-center gap-2">
                    <!-- Current Weather Widget (General) -->
                    <div class="bg-white px-2 py-1.5 rounded-xl shadow-sm border border-gray-100 flex items-center gap-1.5 min-w-[60px] justify-center">
                        <i v-if="weatherLoading" class="ph ph-spinner animate-spin text-jp-accent"></i>
                        <div v-else class="flex items-center gap-1">
                            <span class="text-[10px] text-gray-400">現在</span>
                            <i :class="weatherIcon" class="text-lg text-jp-accent"></i>
                            <span class="text-xs font-bold text-jp-text">{{ currentTemp }}°</span>
                        </div>
                    </div>

                    <!-- Currency Converter Toggle (Global) -->
                    <button @click="showConverterModal = true" class="bg-white p-2 rounded-full shadow-sm border border-gray-100 active:scale-95 transition-transform text-green-600">
                        <i class="ph ph-currency-circle-dollar text-xl"></i>
                    </button>

                    <!-- Shopping List -->
                    <button @click="showShoppingModal = true" class="relative bg-white p-2 rounded-full shadow-sm border border-gray-100 active:scale-95 transition-transform">
                        <i class="ph ph-bag text-xl text-jp-text"></i>
                        <span v-if="shoppingList.filter(i=>!i.done).length > 0" class="absolute -top-1 -right-1 bg-jp-red text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold">
                            {{ shoppingList.filter(i=>!i.done).length }}
                        </span>
                    </button>
                </div>
            </div>

            <!-- Date Selector with Weather Icons -->
            <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-2 snap-x">
                <!-- Todo Tab -->
                <div 
                    @click="currentTab = 'todo'"
                    class="snap-start shrink-0 flex flex-col items-center justify-center w-14 h-20 rounded-2xl transition-all duration-300 cursor-pointer border"
                    :class="currentTab === 'todo' ? 'bg-jp-text text-white shadow-soft transform -translate-y-1 border-jp-text' : 'bg-white border-gray-100 text-gray-400'"
                >
                    <span class="text-xs font-medium">行前</span>
                    <i class="ph ph-check-square mt-1 text-lg"></i>
                </div>

                <!-- Days -->
                <div 
                    v-for="(day, index) in tripData" 
                    :key="index"
                    @click="selectDate(index)"
                    class="snap-start shrink-0 flex flex-col items-center justify-center w-14 h-20 rounded-2xl transition-all duration-300 cursor-pointer border relative"
                    :class="(currentTab === 'schedule' && selectedDateIdx === index) ? 'bg-jp-yellow border-jp-yellow-dark text-jp-text shadow-soft transform -translate-y-1' : 'bg-white border-gray-100 text-gray-400'"
                >
                    <span class="text-[10px] font-medium uppercase">{{ getDayLabel(index) }}</span>
                    <!-- Weather Icon for the Day -->
                    <i :class="day.weather?.icon || 'ph-sun'" class="text-lg my-0.5" :class="(currentTab === 'schedule' && selectedDateIdx === index) ? 'text-jp-text' : 'text-jp-accent'"></i>
                    <span class="text-lg font-bold font-serif">{{ index + 1 }}</span>
                    <span class="text-[10px]">{{ getSimpleDate(index) }}</span>
                    
                    <div v-if="day.items.length > 0" class="absolute bottom-1.5 w-1 h-1 rounded-full bg-jp-accent"></div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-jp-bg pb-24 relative no-scrollbar">
            
            <!-- View: TODO (With Categories) -->
            <div v-if="currentTab === 'todo'" class="px-4 py-4 space-y-6">
                
                <div v-for="(items, category) in todoGroups" :key="category">
                    <h3 class="text-xs font-bold text-gray-400 mb-2 pl-1 border-l-4 border-jp-yellow flex items-center justify-between">
                        {{ category }}
                        <span class="text-[10px] bg-gray-100 px-1.5 rounded-full text-gray-400">{{ items.filter(i=>i.done).length }}/{{ items.length }}</span>
                    </h3>
                    <div class="space-y-2">
                        <div v-for="todo in items" :key="todo.id" class="flex items-center gap-3 bg-white p-3 rounded-xl shadow-card border border-gray-50 active:scale-[0.99] transition-transform group relative">
                            <button @click="todo.done = !todo.done" class="text-xl shrink-0" :class="todo.done ? 'text-jp-accent' : 'text-gray-300'">
                                <i :class="todo.done ? 'ph-fill ph-check-circle' : 'ph ph-circle'"></i>
                            </button>
                            <span :class="{'line-through text-gray-300': todo.done, 'text-jp-text': !todo.done}" class="flex-1 text-sm font-medium">{{ todo.text }}</span>
                            <!-- Edit Todo Button -->
                            <button @click="openTodoModal(todo)" class="text-gray-300 hover:text-blue-400 p-1">
                                <i class="ph ph-pencil-simple"></i>
                            </button>
                            <button @click="removeTodo(todo.id)" class="text-gray-200 hover:text-red-400 p-1">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Floating Action Button for Todo -->
                <button @click="openTodoModal()" class="fixed bottom-24 right-4 bg-jp-text text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-2xl z-40 active:scale-90 transition-transform">
                    <i class="ph-bold ph-plus"></i>
                </button>
                <div class="h-8"></div>
            </div>

            <!-- View: Schedule -->
            <div v-else-if="currentTab === 'schedule'" class="px-4 py-4 space-y-4">
                <div class="flex justify-between items-end mb-2">
                    <h2 class="text-lg font-medium text-jp-text">
                        <span class="border-b-4 border-jp-yellow/50 pb-1">{{ getFullDate(selectedDateIdx) }} 行程</span>
                    </h2>
                    <button @click="openAddItemModal()" class="text-xs bg-jp-text text-white px-3 py-1.5 rounded-full flex items-center gap-1 shadow-lg active:scale-95 transition-transform">
                        <i class="ph ph-plus"></i> 新增
                    </button>
                </div>

                <!-- Weather Card -->
                <div v-if="currentDayWeather" class="bg-gradient-to-r from-blue-50 to-white rounded-xl p-3 shadow-sm border border-blue-100 flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-white p-2 rounded-full shadow-sm text-jp-blue">
                            <i :class="currentDayWeather.icon" class="text-2xl"></i>
                        </div>
                        <div>
                            <div class="flex items-end gap-1.5">
                                <span class="text-xl font-bold text-jp-text font-serif leading-none">{{ currentDayWeather.maxTemp }}°</span>
                                <span class="text-xs text-gray-400 mb-0.5">/ {{ currentDayWeather.minTemp }}°C</span>
                            </div>
                            <div class="text-[10px] text-gray-500 font-medium">
                                體感 {{ currentDayWeather.feelsLike }}°C 
                                <span v-if="currentDayWeather.desc">· {{ currentDayWeather.desc }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-[10px] bg-white px-2 py-1 rounded-full border border-gray-100 text-gray-400 shadow-sm block">
                            {{ currentDayWeather.rainProb > 20 ? '☔ ' + currentDayWeather.rainProb + '%' : '☀️ 晴朗' }}
                        </span>
                    </div>
                </div>

                <div v-if="currentDayItems.length === 0" class="py-12 text-center text-gray-300">
                    <i class="ph ph-map-pin text-4xl mb-2 block opacity-50"></i>
                    安排一點行程吧！
                </div>

                <!-- Sortable List -->
                <div ref="sortableList" class="space-y-4 relative pl-4 border-l-2 border-dashed border-gray-200 ml-2 pb-4">
                    <div v-for="(item, idx) in currentDayItems" :key="item.id" class="relative group cursor-grab active:cursor-grabbing" :data-id="item.id">
                        <!-- Timeline Dot -->
                        <div class="absolute -left-[23px] top-4 w-3.5 h-3.5 bg-white border-2 border-jp-yellow rounded-full z-10"></div>
                        
                        <div class="bg-white rounded-xl p-4 shadow-card border border-gray-50 hover:shadow-md transition-shadow">
                            <!-- Drag Handle -->
                            <div class="absolute right-2 top-2 text-gray-200">
                                <i class="ph ph-dots-six-vertical"></i>
                            </div>

                            <div class="flex justify-between items-start pr-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                                        <span class="bg-jp-bg text-jp-text font-mono text-xs font-bold px-2 py-0.5 rounded border border-gray-100">{{ item.time }}</span>
                                        <span class="text-[10px] text-white px-2 py-0.5 rounded-full" :class="getCategoryColor(item.category)">
                                            {{ item.category }}
                                        </span>
                                        
                                        <!-- Transport Badge -->
                                        <span v-if="item.station" class="flex items-center gap-1 text-[10px] px-1.5 py-0.5 rounded border" 
                                              :class="item.station.includes('BTS') ? 'bg-green-50 text-bts-green border-green-200' : 'bg-blue-50 text-mrt-blue border-blue-200'">
                                            <i class="ph-fill" :class="item.station.includes('BTS') ? 'ph-train-regional' : 'ph-subway'"></i>
                                            {{ item.station }}
                                        </span>
                                    </div>

                                    <h3 class="font-bold text-jp-text text-lg leading-tight">{{ item.location }}</h3>
                                    
                                    <!-- Info Details -->
                                    <div v-if="item.address || item.addressZH || item.addressTH || item.openHours || item.travelTime" class="mt-2 bg-gray-50 rounded-lg p-2 text-xs text-gray-600 space-y-1.5 border border-gray-100">
                                        <div class="flex flex-wrap gap-x-3 gap-y-1">
                                            <div v-if="item.openHours" class="flex items-center gap-1">
                                                <i class="ph-fill ph-clock text-jp-accent"></i>
                                                <span>{{ item.openHours }}</span>
                                            </div>
                                            <div v-if="item.travelTime" class="flex items-center gap-1">
                                                <i class="ph-fill ph-taxi text-jp-blue"></i>
                                                <span>約 {{ item.travelTime }}</span>
                                            </div>
                                            <div v-if="item.exchange" class="flex items-center gap-1">
                                                <i class="ph-fill ph-currency-circle-dollar text-green-500"></i>
                                                <span>{{ item.exchange }}</span>
                                            </div>
                                        </div>
                                        <div v-if="item.addressZH || item.addressTH" class="pt-1.5 mt-1 border-t border-gray-200 space-y-1">
                                            <div v-if="item.addressZH" class="flex items-start gap-1.5">
                                                <span class="bg-gray-200 text-gray-600 px-1 rounded text-[10px] font-bold shrink-0 mt-0.5">中</span>
                                                <span class="text-gray-500 leading-tight">{{ item.addressZH }}</span>
                                            </div>
                                            <div v-if="item.addressTH" class="flex items-start gap-1.5">
                                                <span class="bg-gray-200 text-gray-600 px-1 rounded text-[10px] font-bold shrink-0 mt-0.5">泰</span>
                                                <span class="text-gray-500 font-sans leading-tight select-all">{{ item.addressTH }}</span>
                                            </div>
                                        </div>
                                        <div v-else-if="item.address" class="flex items-start gap-1 text-[10px] text-gray-400">
                                            <i class="ph-fill ph-map-pin mt-0.5"></i>
                                            <span>{{ item.address }}</span>
                                        </div>
                                    </div>

                                    <!-- Notes -->
                                    <div v-if="item.note" class="mt-2 text-xs text-gray-500 flex items-start gap-1">
                                        <i class="ph ph-note-pencil mt-0.5"></i>
                                        <span>{{ item.note }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex items-center justify-end gap-3 mt-3 pt-2 border-t border-gray-50">
                                <button @click="openAddItemModal(item)" class="text-gray-400 hover:text-blue-500 text-xs flex items-center gap-1">
                                    <i class="ph ph-pencil-simple"></i> 編輯
                                </button>
                                <button @click="deleteItem(item.id)" class="text-gray-400 hover:text-red-400 text-xs flex items-center gap-1">
                                    <i class="ph ph-trash"></i> 刪除
                                </button>
                                <button @click="navigateTo(item)" class="text-blue-500 hover:text-blue-600 text-xs font-bold flex items-center gap-1 bg-blue-50 px-2 py-1 rounded-md">
                                    <i class="ph-fill ph-navigation-arrow"></i> 導航
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Map -->
            <div v-else-if="currentTab === 'map'" class="h-full w-full relative">
                <div id="map" class="w-full h-full z-10 bg-gray-100"></div>
                
                <!-- Map Controls Overlay -->
                <div class="absolute top-4 left-4 z-[500] flex flex-col gap-2">
                    <div class="bg-white/90 backdrop-blur px-3 py-1.5 rounded-lg shadow text-xs font-medium border border-gray-200 text-gray-600 flex items-center gap-1">
                        <i class="ph-fill ph-google-logo text-blue-500"></i>
                        Google Maps 圖層
                    </div>

                    <!-- Metro Search Map Link -->
                    <a href="https://metro.nuua.travel/zh-cht/bangkok" target="_blank" 
                        class="bg-white px-4 py-2 rounded-xl shadow-lg border border-jp-blue/20 text-jp-blue font-bold text-xs flex items-center gap-2 active:scale-95 transition-transform"
                    >
                        <i class="ph-fill ph-train-regional text-lg"></i>
                        曼谷地鐵搜索圖
                    </a>

                    <!-- Metro Map Image Button -->
                    <button @click="showMetroMap = true" 
                        class="bg-white px-4 py-2 rounded-xl shadow-lg border border-jp-blue/20 text-jp-blue font-bold text-xs flex items-center gap-2 active:scale-95 transition-transform"
                    >
                        <i class="ph-fill ph-map-trifold text-lg"></i>
                        曼谷地鐵全線圖
                    </button>
                </div>

                <!-- Google Maps External Link -->
                <button @click="openInGoogleMaps" class="absolute bottom-6 left-4 z-[500] bg-white px-4 py-2 rounded-full shadow-float text-jp-text font-bold text-xs flex items-center gap-2 border border-gray-100 active:bg-gray-50">
                    <i class="ph-fill ph-arrow-square-out text-jp-blue"></i>
                    開啟 Google Maps App
                </button>

                <!-- Locate Me -->
                <button @click="locateMe" class="absolute bottom-6 right-4 z-[500] bg-white p-3 rounded-full shadow-float text-jp-text active:bg-gray-50">
                    <i class="ph ph-crosshair text-xl"></i>
                </button>
            </div>

            <!-- View: Wallet -->
            <div v-else-if="currentTab === 'wallet'" class="px-4 py-6 space-y-6">
                <!-- Summary Card -->
                <div class="bg-jp-text text-white rounded-2xl p-6 shadow-float relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-jp-yellow rounded-full opacity-10 translate-x-10 -translate-y-10 blur-2xl"></div>
                    <h3 class="text-sm text-gray-300 font-medium mb-4">總支出統計</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-xs text-gray-400 block">泰銖總計 (THB)</span>
                            <span class="text-2xl font-bold font-mono">฿{{ totalThb.toLocaleString() }}</span>
                        </div>
                        <div class="text-right border-l border-gray-700 pl-4">
                            <span class="text-xs text-gray-400 block">台幣總計 (TWD)</span>
                            <span class="text-2xl font-bold font-mono text-jp-yellow">NT${{ totalTwd.toLocaleString() }}</span>
                        </div>
                    </div>
                </div>

                <!-- Wallet Embedded Converter -->
                <div class="bg-white rounded-xl p-4 shadow-card border border-gray-50">
                    <h4 class="text-xs font-bold text-gray-400 mb-2 flex items-center gap-1">
                        <i class="ph-bold ph-arrows-left-right text-jp-yellow-dark"></i> 快速換算
                    </h4>
                    <div class="flex items-center gap-2">
                        <div class="flex-1 relative">
                            <span class="absolute left-3 top-2 text-gray-400 text-xs font-bold">THB</span>
                            <input type="number" v-model="walletConverterInput" class="w-full bg-gray-50 pl-10 pr-2 py-2 rounded-lg text-sm font-mono outline-none focus:ring-1 ring-jp-yellow font-bold text-jp-text" placeholder="0">
                        </div>
                        <i class="ph-bold ph-arrow-right text-gray-300"></i>
                        <div class="flex-1 bg-gray-100 p-2 rounded-lg text-sm font-mono text-jp-text font-bold text-right flex justify-between items-center px-3">
                            <span class="text-gray-400 text-xs">TWD</span>
                            <span>{{ walletConverterResult }}</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center pt-2">
                    <h3 class="font-bold text-jp-text">每日明細</h3>
                    <button @click="showExpenseModal = true" class="text-xs bg-jp-yellow text-jp-text font-bold px-3 py-1.5 rounded-full shadow-sm">
                        + 記帳
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- Updated Group Loop for Expense List -->
                    <div v-for="group in expenseGroups" :key="group.dateKey">
                        <h4 class="text-xs font-bold text-gray-400 mb-2 pl-2 border-l-2 border-jp-accent">{{ group.title }}</h4>
                        <div class="space-y-2">
                            <div v-for="exp in group.items" :key="exp.id" class="bg-white p-3 rounded-xl shadow-card border border-gray-50 flex justify-between items-center group relative">
                                <div class="flex-1">
                                    <p class="text-sm font-bold text-jp-text">{{ exp.title }}</p>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="text-[10px] text-white px-1.5 py-0.5 rounded" :class="getCategoryColor(exp.category)">{{ exp.category }}</span>
                                        <span v-if="exp.note" class="text-[10px] text-gray-400 truncate max-w-[150px] bg-gray-50 px-1.5 py-0.5 rounded">{{ exp.note }}</span>
                                    </div>
                                </div>
                                <div class="text-right mr-6">
                                    <p class="font-mono font-bold" :class="exp.currency === 'THB' ? 'text-gray-600' : 'text-jp-text'">
                                        {{ exp.currency === 'THB' ? '฿' : 'NT$' }}{{ exp.amount }}
                                    </p>
                                </div>
                                <button @click="editExpense(exp)" class="absolute right-2 text-gray-300 hover:text-blue-400 p-1">
                                    <i class="ph ph-pencil-simple"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Info -->
            <div v-else-if="currentTab === 'info'" class="px-4 py-6 space-y-4">
                <h2 class="text-lg font-medium text-jp-text flex items-center gap-2 mb-4">
                    <i class="ph-fill ph-info text-jp-yellow-dark"></i>
                    <span class="border-b-4 border-jp-yellow/50 pb-1">資訊 & 備案</span>
                </h2>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-4 rounded-xl shadow-card border border-gray-50 flex flex-col items-center text-center gap-2">
                        <i class="ph-fill ph-first-aid text-3xl text-red-500"></i>
                        <h3 class="font-bold text-sm">緊急醫療</h3>
                        <p class="text-xs text-gray-400">曼谷醫院: 1719</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-card border border-gray-50 flex flex-col items-center text-center gap-2">
                        <i class="ph-fill ph-police-car text-3xl text-blue-800"></i>
                        <h3 class="font-bold text-sm">觀光警察</h3>
                        <p class="text-xs text-gray-400">撥打 1155</p>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-jp-text text-sm">Plan B 備案景點</h3>
                    </div>
                    <div class="space-y-3">
                        <div v-for="(info, i) in infoList" :key="i" class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm relative group">
                            <h4 class="font-bold text-jp-text text-sm mb-2 pr-8">{{ info.name }}</h4>
                            <div class="space-y-2 text-xs">
                                <div class="flex items-start gap-2">
                                    <span class="bg-gray-100 text-gray-500 px-1.5 rounded text-[10px]">中</span>
                                    <span class="text-gray-600 flex-1">{{ info.addressZH }}</span>
                                    <button @click="copyToClipboard(info.addressZH)" class="text-gray-300 hover:text-jp-blue px-1"><i class="ph ph-copy"></i></button>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="bg-gray-100 text-gray-500 px-1.5 rounded text-[10px]">泰</span>
                                    <span class="text-gray-500 font-sans select-all flex-1">{{ info.addressTH }}</span>
                                    <button @click="copyToClipboard(info.addressTH)" class="text-gray-300 hover:text-jp-blue px-1"><i class="ph ph-copy"></i></button>
                                </div>
                                <div v-if="info.openHours" class="flex items-start gap-2 mt-1">
                                    <i class="ph-fill ph-clock text-gray-300 mt-0.5"></i>
                                    <span class="text-gray-500">{{ info.openHours }}</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3 mt-3 pt-2 border-t border-gray-50">
                                <button @click="addPlanBToSchedule(info)" class="flex-1 bg-jp-blue/10 text-jp-blue py-1.5 rounded-lg text-xs font-bold flex items-center justify-center gap-1 hover:bg-jp-blue/20">
                                    <i class="ph-bold ph-calendar-plus"></i> 加入行程
                                </button>
                                <button @click="editInfoItem(info, i)" class="text-gray-300 hover:text-blue-400 p-1">
                                    <i class="ph ph-pencil-simple text-lg"></i>
                                </button>
                                <button @click="infoList.splice(i,1)" class="text-gray-300 hover:text-red-400 p-1">
                                    <i class="ph ph-trash text-lg"></i>
                                </button>
                            </div>
                        </div>
                        
                        <button @click="addInfoItem" class="w-full py-3 border border-dashed border-gray-300 rounded-xl text-gray-400 text-xs flex items-center justify-center gap-2 hover:bg-gray-50">
                            <i class="ph ph-plus"></i> 新增備案景點
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <!-- Bottom Nav -->
        <nav class="bg-white border-t border-gray-100 flex justify-around items-center h-20 pb-4 fixed bottom-0 w-full max-w-[480px] z-40 text-[10px] font-medium text-gray-400">
            <button @click="switchTab('schedule')" :class="{'text-jp-text': currentTab === 'schedule'}" class="flex flex-col items-center gap-1 w-16">
                <i class="ph text-2xl" :class="currentTab === 'schedule' ? 'ph-calendar-check-fill' : 'ph-calendar-check'"></i>
                行程
            </button>
            <button @click="switchTab('map')" :class="{'text-jp-text': currentTab === 'map'}" class="flex flex-col items-center gap-1 w-16">
                <i class="ph text-2xl" :class="currentTab === 'map' ? 'ph-map-trifold-fill' : 'ph-map-trifold'"></i>
                地圖
            </button>
            <button @click="switchTab('wallet')" :class="{'text-jp-text': currentTab === 'wallet'}" class="flex flex-col items-center gap-1 w-16">
                <i class="ph text-2xl" :class="currentTab === 'wallet' ? 'ph-wallet-fill' : 'ph-wallet'"></i>
                記帳
            </button>
            <button @click="switchTab('info')" :class="{'text-jp-text': currentTab === 'info'}" class="flex flex-col items-center gap-1 w-16">
                <i class="ph text-2xl" :class="currentTab === 'info' ? 'ph-info-fill' : 'ph-info'"></i>
                資訊
            </button>
        </nav>

        <!-- Currency Converter Modal -->
        <transition name="slide-up">
            <div v-if="showConverterModal" class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center pointer-events-none">
                <div class="absolute inset-0 bg-black/30 backdrop-blur-sm pointer-events-auto" @click="showConverterModal = false"></div>
                <div class="bg-white w-full max-w-[480px] rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl z-50 pointer-events-auto">
                    <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-xl text-jp-text flex items-center gap-2">
                            <i class="ph-fill ph-currency-circle-dollar text-green-500"></i> 即時匯率換算
                        </h3>
                        <button @click="showConverterModal = false" class="text-gray-400 hover:text-gray-600">
                            <i class="ph ph-x text-xl"></i>
                        </button>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-xs font-bold text-gray-500">泰銖 (THB)</label>
                                <span class="text-xs text-gray-400">輸入金額</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-2xl font-bold text-gray-400">฿</span>
                                <input type="number" v-model="converterThb" placeholder="0" class="w-full bg-transparent text-3xl font-bold text-jp-text outline-none font-mono">
                            </div>
                        </div>
                        <div class="flex justify-center -my-3 relative z-10">
                            <div class="bg-white border border-gray-200 rounded-full p-2 text-gray-400 shadow-sm"><i class="ph-bold ph-arrow-down"></i></div>
                        </div>
                        <div class="bg-jp-text rounded-2xl p-4 text-white shadow-lg">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-xs font-bold text-gray-300">台幣 (TWD)</label>
                                <span class="text-xs text-gray-400">約合</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-2xl font-bold text-gray-400">NT$</span>
                                <div class="text-3xl font-bold font-mono">{{ convertedTwd }}</div>
                            </div>
                        </div>
                        <div class="text-center text-xs text-gray-400">匯率設定: 1 THB ≈ {{ exchangeRate }} TWD</div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Metro Map Modal -->
        <transition name="fade">
            <div v-if="showMetroMap" class="fixed inset-0 z-[200] flex items-center justify-center bg-black/90 p-4" @click="showMetroMap = false">
                <div class="relative w-full max-w-4xl max-h-[90vh] overflow-hidden rounded-lg flex flex-col items-center bg-transparent">
                    <button class="absolute top-2 right-2 bg-black/50 text-white rounded-full p-2 z-10" @click.stop="showMetroMap = false">
                        <i class="ph ph-x text-2xl"></i>
                    </button>
                    
                    <div class="overflow-auto w-full h-full bg-white flex justify-center items-start">
                        <!-- Zoomable Image Container -->
                        <div :style="{ transform: `scale(${mapZoom})`, transformOrigin: 'top left', transition: 'transform 0.2s' }" class="relative">
                            <img src="https://b4129287.smushcdn.com/4129287/wp-content/uploads/2024/08/%E6%9B%BC%E8%B0%B7%E5%9C%B0%E9%90%B5%E5%9C%96-768x637.jpg?lossy=2&strip=1&avif=1" 
                                 alt="曼谷地鐵圖" 
                                 class="max-w-none"
                                 style="width: 1000px; height: auto;"
                                 onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/2/25/Bangkok_Transit_Map.png/1920px-Bangkok_Transit_Map.png';">
                        </div>
                    </div>

                    <!-- Zoom Controls -->
                    <div class="absolute bottom-6 right-6 flex flex-col gap-2 z-20">
                        <button @click.stop="mapZoom += 0.2" class="bg-white text-jp-text w-10 h-10 rounded-full shadow-lg flex items-center justify-center text-xl active:bg-gray-100"><i class="ph-bold ph-plus"></i></button>
                        <button @click.stop="mapZoom = Math.max(0.5, mapZoom - 0.2)" class="bg-white text-jp-text w-10 h-10 rounded-full shadow-lg flex items-center justify-center text-xl active:bg-gray-100"><i class="ph-bold ph-minus"></i></button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Add/Edit Item Modal -->
        <transition name="slide-up">
            <div v-if="showAddModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                <div class="absolute inset-0 bg-black/30 backdrop-blur-sm pointer-events-auto transition-opacity" @click="showAddModal = false"></div>
                <div class="bg-white w-full max-w-[480px] rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl z-50 pointer-events-auto h-[85vh] overflow-y-auto">
                    <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                    <h3 class="font-bold text-xl mb-6 text-jp-text">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                    
                    <!-- Date Selector for Plan B or General Adding -->
                    <div class="mb-4">
                        <label class="block text-xs text-gray-500 mb-1">日期</label>
                        <select v-model="targetDateIdx" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm font-bold text-jp-text">
                            <option v-for="(day, index) in tripData" :key="index" :value="index">
                                Day {{ index + 1 }} - {{ getSimpleDate(index) }}
                            </option>
                        </select>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">類別</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button v-for="cat in categories" :key="cat.val" 
                                    @click="newItem.category = cat.val"
                                    class="py-2 rounded-lg text-xs font-medium border transition-colors"
                                    :class="newItem.category === cat.val ? 'bg-jp-text text-white border-jp-text' : 'bg-white border-gray-200 text-gray-600'"
                                >
                                    {{ cat.label }}
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <div class="w-1/3">
                                <label class="block text-xs text-gray-500 mb-1">時間</label>
                                <input v-model="newItem.time" type="time" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm border border-transparent focus:border-jp-yellow transition-colors">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">地點</label>
                                <input v-model="newItem.location" type="text" placeholder="輸入地點..." class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm border border-transparent focus:border-jp-yellow transition-colors">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">最近捷運站 (選填)</label>
                            <input v-model="newItem.station" type="text" placeholder="例如: BTS Siam" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm border border-transparent focus:border-jp-yellow transition-colors">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">備註</label>
                            <textarea v-model="newItem.note" rows="3" placeholder="票價、注意事項..." class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm border border-transparent focus:border-jp-yellow transition-colors resize-none"></textarea>
                        </div>
                        
                        <!-- Extra Fields for Details -->
                        <div class="grid grid-cols-2 gap-2">
                             <div>
                                <label class="block text-xs text-gray-500 mb-1">中文地址 (選填)</label>
                                <input v-model="newItem.addressZH" type="text" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-xs">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">泰文地址 (選填)</label>
                                <input v-model="newItem.addressTH" type="text" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-xs">
                            </div>
                        </div>

                        <button @click="saveItem" class="w-full bg-jp-yellow text-jp-text py-3.5 rounded-xl font-bold shadow-lg mt-4 active:scale-[0.98] transition-transform">
                            {{ isEditing ? '儲存修改' : '加入行程' }}
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Edit Info Modal -->
        <transition name="slide-up">
            <div v-if="showInfoModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                <div class="absolute inset-0 bg-black/30 backdrop-blur-sm pointer-events-auto" @click="showInfoModal = false"></div>
                <div class="bg-white w-full max-w-[480px] rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl z-50 pointer-events-auto">
                    <h3 class="font-bold text-xl mb-6 text-jp-text">編輯備案景點</h3>
                    <div class="space-y-3">
                        <input v-model="editingInfo.name" type="text" placeholder="景點名稱" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm">
                        <input v-model="editingInfo.addressZH" type="text" placeholder="中文地址" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm">
                        <input v-model="editingInfo.addressTH" type="text" placeholder="泰文地址" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm">
                        <input v-model="editingInfo.openHours" type="text" placeholder="營業時間 (如: 10:00-22:00)" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm">
                        <button @click="saveInfoItem" class="w-full bg-jp-yellow text-jp-text py-3 rounded-xl font-bold shadow-lg">儲存</button>
                    </div>
                </div>
            </div>
        </transition>
        
        <!-- Todo Modal -->
        <transition name="slide-up">
            <div v-if="showTodoModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                <div class="absolute inset-0 bg-black/30 backdrop-blur-sm pointer-events-auto" @click="showTodoModal = false"></div>
                <div class="bg-white w-full max-w-[480px] rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl z-50 pointer-events-auto">
                    <h3 class="font-bold text-xl mb-6 text-jp-text">{{ isEditingTodo ? '編輯待辦' : '新增待辦' }}</h3>
                    <div class="space-y-3">
                        <input v-model="newTodo.text" type="text" placeholder="待辦事項內容" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm">
                        
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">分類</label>
                            <select v-model="newTodo.category" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm font-bold text-jp-text">
                                <option v-for="cat in ['行前準備', '重要文件', '3C產品', '盥洗用品', '個人藥品', '個人衣物', '其他']" :key="cat" :value="cat">
                                    {{ cat }}
                                </option>
                            </select>
                        </div>
                        
                        <button @click="saveTodo" class="w-full bg-jp-yellow text-jp-text py-3 rounded-xl font-bold shadow-lg mt-2">儲存</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Shopping List Modal -->
        <transition name="slide-up">
            <div v-if="showShoppingModal" class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center pointer-events-none">
                <div class="absolute inset-0 bg-black/30 backdrop-blur-sm pointer-events-auto" @click="showShoppingModal = false"></div>
                <div class="bg-white w-full max-w-[480px] rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl z-50 pointer-events-auto h-[70vh] flex flex-col">
                    <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-4"></div>
                    <h3 class="font-bold text-xl mb-4 text-jp-text flex items-center gap-2">
                        <i class="ph-fill ph-bag text-jp-red"></i> 購物清單
                    </h3>
                    
                    <div class="flex gap-2 mb-4">
                        <input v-model="newShopItem" @keyup.enter="addShopItem" type="text" placeholder="想買什麼？" class="flex-1 bg-gray-50 p-2 rounded-xl outline-none border focus:border-jp-yellow">
                        <button @click="addShopItem" class="bg-jp-text text-white px-4 rounded-xl"><i class="ph ph-plus"></i></button>
                    </div>

                    <div class="flex-1 overflow-y-auto space-y-2">
                        <div v-if="shoppingList.length === 0" class="text-center text-gray-300 py-8">空空如也</div>
                        <div v-for="item in shoppingList" :key="item.id" class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg">
                            <button @click="item.done = !item.done" :class="item.done ? 'text-jp-red' : 'text-gray-300'">
                                <i :class="item.done ? 'ph-fill ph-check-square' : 'ph ph-square'"></i>
                            </button>
                            <span :class="{'line-through text-gray-300': item.done}" class="flex-1 text-sm">{{ item.text }}</span>
                            <button @click="shoppingList = shoppingList.filter(i => i.id !== item.id)" class="text-gray-300"><i class="ph ph-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Expense Modal -->
        <transition name="slide-up">
            <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                <div class="absolute inset-0 bg-black/30 backdrop-blur-sm pointer-events-auto" @click="showExpenseModal = false"></div>
                <div class="bg-white w-full max-w-[480px] rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl z-50 pointer-events-auto">
                    <h3 class="font-bold text-lg mb-4 text-jp-text">{{ isEditingExpense ? '編輯支出' : '新增支出' }}</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">日期</label>
                            <select v-model="newExpense.dayIdx" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm font-bold text-jp-text">
                                <option :value="-1">行前花費</option>
                                <option v-for="(day, index) in tripData" :key="index" :value="index">
                                    Day {{ index + 1 }} - {{ getSimpleDate(index) }}
                                </option>
                            </select>
                        </div>
                        <input v-model="newExpense.title" type="text" placeholder="項目名稱 (如：計程車)" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm">
                        
                        <div class="flex flex-col gap-1">
                            <div class="flex gap-2">
                                <select v-model="newExpense.currency" class="bg-gray-50 p-3 rounded-xl outline-none text-sm font-mono">
                                    <option value="TWD">NT$</option>
                                    <option value="THB">฿THB</option>
                                </select>
                                <input v-model="newExpense.amount" type="number" placeholder="金額" class="flex-1 bg-gray-50 p-3 rounded-xl outline-none text-sm font-mono">
                            </div>
                            <div v-if="newExpense.currency === 'THB' && newExpense.amount" class="text-xs text-gray-400 text-right pr-1 animate-pulse">
                                ≈ NT$ {{ (newExpense.amount * exchangeRate).toFixed(0) }}
                            </div>
                        </div>

                        <select v-model="newExpense.category" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm">
                            <option v-for="cat in categories" :key="cat.val" :value="cat.label">{{ cat.label }}</option>
                        </select>
                        
                        <input v-model="newExpense.note" type="text" placeholder="備註 (選填，如：代墊、刷卡)" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm">

                        <button @click="addExpense" class="w-full bg-jp-yellow text-jp-text py-3 rounded-xl font-bold shadow-lg mt-2">儲存</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            const tripTitle = ref('曼谷六天五夜之旅 🇹🇭');
            const tripDays = ref(6);
            const startDate = new Date('2025-11-18');
            const currentTab = ref('schedule');
            const selectedDateIdx = ref(0);
            
            // --- Global Converter ---
            const showConverterModal = ref(false);
            const converterThb = ref('');
            const exchangeRate = ref(0.92);
            const convertedTwd = computed(() => {
                if(!converterThb.value) return '0';
                return (parseFloat(converterThb.value) * exchangeRate.value).toFixed(0);
            });

            const walletConverterInput = ref('');
            const walletConverterResult = computed(() => {
                if(!walletConverterInput.value) return '0';
                return (parseFloat(walletConverterInput.value) * exchangeRate.value).toFixed(0);
            });

            // --- Weather ---
            const weatherLoading = ref(true);
            const currentTemp = ref('--');
            const weatherCode = ref(0);
            
            // --- Map Logic ---
            const showMetroMap = ref(false);
            const mapZoom = ref(1.0);

            const tripData = ref(Array.from({ length: tripDays.value }, (_, i) => ({
                dayIdx: i,
                weather: { icon: 'ph-question', minTemp: '--', maxTemp: '--', feelsLike: '--', rainProb: 0, desc: '載入中...' },
                items: []
            })));

            // --- Data ---
            tripData.value[0].items = [
                { id: 101, time: '08:05', location: '桃機T2 ✈️ BKK', category: '航班', note: '長榮航空 BR 08:05 -> 11:10 抵達', lat: 25.079, lng: 121.234 },
                { id: 102, time: '12:00', location: 'BKK 機場換錢', category: '其他', note: 'B1 Orange Super Rich (靠左直走)', lat: 13.6900, lng: 100.7501, station: 'ARL Suvarnabhumi', addressZH: '素萬那普機場 B1 層', addressTH: 'ชั้น B1 ท่าอากาศยานสุวรรณภูมิ' },
                { id: 103, time: '14:00', location: 'Check-in 住宿', category: '住宿', note: '前往住宿地點放行李', lat: 13.7563, lng: 100.5018 }
            ];
            
            tripData.value[1].items = [
                { id: 201, time: '10:00', location: 'Ari 文青街區', category: '景點', note: 'BTS Ari 3號出口', lat: 13.780, lng: 100.544, station: 'BTS Ari', addressZH: 'Ari 街區', addressTH: 'ซอยอารีย์' },
                { id: 202, time: '11:00', location: 'NANA Coffee Roasters', category: '美食', lat: 13.782, lng: 100.545, note: '冠軍級精品咖啡', addressZH: 'NANA Coffee Roasters Ari', addressTH: '24/2 ซอยอารีย์ 4' },
                { id: 203, time: '14:00', location: '朱拉美食一條街', category: '美食', note: '14:00-23:30', lat: 13.740, lng: 100.523, station: 'MRT Samyan', addressZH: 'Banthat Thong Rd', addressTH: 'ถนนบรรทัดทอง' },
                { id: 204, time: '17:00', location: '朱拉50巷廚房', category: '美食', note: '咖喱蟹肉、炒飯', lat: 13.735, lng: 100.525, addressZH: '朱拉50巷廚房', addressTH: 'ครัวจุฬา 50' },
                { id: 205, time: '19:00', location: 'Nueng Nom Nue', category: '美食', note: '牛奶小子', lat: 13.741, lng: 100.522, addressZH: 'Nueng Nom Nua', addressTH: 'หนึ่ง นม นัว' },
                { id: 206, time: '20:30', location: 'Jeh O Chula', category: '美食', note: '冬蔭媽媽麵', lat: 13.742, lng: 100.522, addressZH: 'Jeh O Chula', addressTH: 'เจ๊โอว ข้าวต้มเป็ด' },
                { id: 207, time: '22:00', location: 'June Pang', category: '美食', note: '焦糖醬厚切吐司', lat: 13.741, lng: 100.523, addressZH: 'June Pang Toast', addressTH: 'จูนปัง ขนมปังโทสต์' }
            ];

            tripData.value[2].items = [
                { id: 301, time: '10:00', location: '恰圖恰市集', category: '購物', note: 'MRT 2號出口 (推薦3-4區服飾)', lat: 13.799, lng: 100.550, station: 'MRT Kamphaeng Phet', addressZH: '恰圖恰週末市集', addressTH: 'ตลาดนัดจตุจักร' }
            ];

            tripData.value[3].items = [
                { id: 401, time: '09:00', location: '水門市場', category: '購物', note: '5:00-21:00, 批發服飾', lat: 13.751, lng: 100.540, station: 'BTS Chit Lom', addressZH: '水門市場', addressTH: 'ตลาดประตูน้ำ' },
                { id: 402, time: '12:00', location: 'The Place 168', category: '美食', note: '冬蔭功麵', lat: 13.752, lng: 100.541, addressZH: 'The Place 168', addressTH: 'The Place 168' },
                { id: 403, time: '14:00', location: 'Siam Paragon', category: '購物', note: '高級百貨', lat: 13.746, lng: 100.534, station: 'BTS Siam', addressZH: '暹羅百麗宮', addressTH: 'สยามพารากอน' },
                { id: 404, time: '15:30', location: 'Siam Square One', category: '購物', note: '彩妝、潮牌', lat: 13.745, lng: 100.533, station: 'BTS Siam', addressZH: '暹羅廣場一號', addressTH: 'สยามสแควร์วัน' },
                { id: 405, time: '17:00', location: 'Central World', category: '購物', note: '7F Chunn/After You. ⚠️ 7樓精品特賣', lat: 13.746, lng: 100.539, station: 'BTS Chit Lom', addressZH: '中央世界購物中心', addressTH: 'เซ็นทรัลเวิลด์' },
                { id: 406, time: '19:30', location: 'LV Visionary Journeys', category: '景點', note: '免費展覽 (需預約)', lat: 13.744, lng: 100.541, station: 'BTS Chit Lom', addressZH: 'LV The Place Bangkok', addressTH: 'Gaysorn Amarin' }
            ];

            // Day 5: 11/22 (New Full Day)
            tripData.value[4].items = [
                { 
                    id: 501, 
                    time: '10:00', 
                    location: '自由活動 / 補貨', 
                    category: '其他', 
                    note: '可安排 Plan B 景點或最後採買', 
                    lat: 13.7563, 
                    lng: 100.5018
                },
                {
                    id: 502,
                    time: '22:00',
                    location: '前往 BKK 機場',
                    category: '交通',
                    note: '準備搭乘凌晨 02:15 班機',
                    lat: 13.6900,
                    lng: 100.7501,
                    station: 'ARL Suvarnabhumi',
                    addressZH: '素萬那普機場',
                    addressTH: 'ท่าอากาศยานสุวรรณภูมิ'
                }
            ];

            // Day 6: 11/23 (Return Flight)
            tripData.value[5].items = [
                { 
                    id: 601, 
                    time: '02:15', 
                    location: 'BKK 素萬那普 ✈️ TPE', 
                    category: '航班', 
                    note: '長榮 BR206 / 06:40 抵達桃機', 
                    lat: 13.6900, 
                    lng: 100.7501
                }
            ];

            const todoList = ref([
                { id: 1, text: '辦理泰國簽證/落地簽', done: false, category: '行前準備' },
                { id: 2, text: '機票確認 (長榮)', done: true, category: '行前準備' },
                { id: 3, text: '住宿預訂 (3906/2人)', done: true, category: '行前準備' },
                { id: 4, text: '下載 Grab / Bolt', done: false, category: '行前準備' },
                { id: 5, text: '預約 LV 展覽', done: false, category: '行前準備' },
                { id: 10, text: '護照 (效期6個月以上)', done: false, category: '重要文件' },
                { id: 11, text: '身分證', done: true, category: '重要文件' },
                { id: 20, text: '手機', done: true, category: '3C產品' },
                { id: 23, text: '網卡', done: false, category: '3C產品' },
                { id: 30, text: '換洗衣物', done: false, category: '個人衣物' }
            ]);

            const shoppingList = ref([
                { id: 1, text: '手標泰奶', done: false },
                { id: 2, text: '媽媽麵 (MAMA)', done: false },
                { id: 3, text: '番茄餅乾', done: false },
                { id: 4, text: '大象啤酒', done: false }
            ]);

            const expenses = ref([
                { id: 1, dayIdx: -1, title: '長榮機票 (人)', amount: 7599, currency: 'TWD', category: '交通', note: '' },
                { id: 2, dayIdx: -1, title: '住宿 (2人總計)', amount: 3906, currency: 'TWD', category: '住宿', note: '' }
            ]);

            const infoList = ref([
                { name: '唐人街 (華蓮寺站)', addressZH: '曼谷耀華力路', addressTH: 'ถนนเยาวราช', openHours: '18:00-00:00' },
                { name: 'Iconsiam 室內水上市場', addressZH: '曼谷昭披耶河畔', addressTH: 'ไอคอนสยาม', openHours: '10:00-22:00' },
                { name: '愛麗絲仙境咖啡廳', addressZH: '曼谷素坤逸 36 巷', addressTH: 'ซอยสุขุมวิท 36', openHours: '10:00-18:00' },
                { name: 'Emspere 百貨', addressZH: 'EmSphere (BTS Phrom Phong)', addressTH: 'เอ็มสเฟียร์', openHours: '10:00-22:00' },
                { name: '榮泰米粉湯', addressZH: '榮泰 (Sukhumvit 26)', addressTH: 'ก๋วยเตี๋ยวหมูรุ่งเรือง', openHours: '08:00-17:00' },
                { name: 'Here Hai 蟹肉炒飯', addressZH: 'Here Hai (Ekkamai)', addressTH: 'เฮียให้', openHours: '10:00-14:30' },
                { name: 'Mae Varee 芒果糯米', addressZH: 'Mae Varee (Thong Lo)', addressTH: 'แม่วารี', openHours: '06:00-22:00' },
                { name: 'Nings Mango Stand', addressZH: 'Nings Mango Stand', addressTH: 'Nings Mango Stand', openHours: '13:00-22:00' }
            ]);

            const showAddModal = ref(false);
            const showShoppingModal = ref(false);
            const showExpenseModal = ref(false);
            const showInfoModal = ref(false);
            const showTodoModal = ref(false);
            
            const isEditing = ref(false);
            const isEditingExpense = ref(false);
            const isEditingTodo = ref(false);
            
            const newItem = ref({ time: '', location: '', category: '景點', note: '', station: '', addressZH: '', addressTH: '' });
            const editingInfo = ref({});
            const editingInfoIndex = ref(-1);
            
            const newExpense = ref({ id: null, title: '', amount: '', currency: 'THB', category: '美食', dayIdx: 0, note: '' });
            const newTodo = ref({ id: null, text: '', category: '其他' });
            
            // This is for selecting date when adding Plan B to schedule
            const targetDateIdx = ref(0);

            const newTodoText = ref('');
            const newShopItem = ref('');

            const categories = [
                { val: '景點', label: '景點' }, { val: '交通', label: '交通' },
                { val: '航班', label: '航班' }, { val: '美食', label: '美食' },
                { val: '購物', label: '購物' }, { val: '其他', label: '其他' },
                { val: '住宿', label: '住宿' }
            ];

            const getDayNumber = (idx) => { const d = new Date(startDate); d.setDate(d.getDate() + idx); return d.getDate(); };
            const getDayLabel = (idx) => { const days = ['週日', '週一', '週二', '週三', '週四', '週五', '週六']; const d = new Date(startDate); d.setDate(d.getDate() + idx); return days[d.getDay()]; };
            const getFullDate = (idx) => { const d = new Date(startDate); d.setDate(d.getDate() + idx); return `${d.getMonth()+1}/${d.getDate()} (${getDayLabel(idx)})`; };
            const getSimpleDate = (idx) => { const d = new Date(startDate); d.setDate(d.getDate() + idx); return `${d.getMonth()+1}/${d.getDate()}`; };

            const currentDayItems = computed(() => tripData.value[selectedDateIdx.value].items);
            const currentDayWeather = computed(() => tripData.value[selectedDateIdx.value].weather);

            const expenseGroups = computed(() => {
                const groups = {};
                expenses.value.forEach(exp => { 
                    if (!groups[exp.dayIdx]) groups[exp.dayIdx] = []; 
                    groups[exp.dayIdx].push(exp); 
                });
                
                // Sort keys: -1 first, then 0, 1, 2...
                const sortedKeys = Object.keys(groups).sort((a, b) => parseInt(a) - parseInt(b));
                
                return sortedKeys.map(key => ({
                    dateKey: parseInt(key),
                    title: parseInt(key) === -1 ? '行前花費' : getFullDate(parseInt(key)),
                    items: groups[key]
                }));
            });
            const totalThb = computed(() => expenses.value.filter(e => e.currency === 'THB').reduce((acc, e) => acc + parseFloat(e.amount), 0));
            const totalTwd = computed(() => expenses.value.filter(e => e.currency === 'TWD').reduce((acc, e) => acc + parseFloat(e.amount), 0));
            
            const todoGroups = computed(() => {
                const groups = {};
                const order = ['行前準備', '重要文件', '3C產品', '盥洗用品', '個人藥品', '個人衣物', '其他'];
                order.forEach(key => groups[key] = []);
                todoList.value.forEach(item => {
                    const cat = item.category || '其他';
                    if (!groups[cat]) groups[cat] = [];
                    groups[cat].push(item);
                });
                return Object.fromEntries(Object.entries(groups).filter(([k, v]) => v.length > 0));
            });

            const weatherIcon = computed(() => {
                const c = weatherCode.value;
                if (c === 0) return 'ph-sun text-yellow-500';
                if (c >= 1 && c <= 3) return 'ph-cloud-sun text-gray-500';
                return 'ph-cloud text-gray-400';
            });

            const fetchWeather = async () => {
                try {
                    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=13.7563&longitude=100.5018&daily=weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,precipitation_probability_max&timezone=Asia%2FBangkok&start_date=2025-11-18&end_date=2025-11-23');
                    const data = await res.json();
                    if(data.daily) {
                        data.daily.time.forEach((t, i) => {
                            if (tripData.value[i]) {
                                tripData.value[i].weather = {
                                    icon: 'ph-sun text-yellow-500', 
                                    maxTemp: Math.round(data.daily.temperature_2m_max[i]),
                                    minTemp: Math.round(data.daily.temperature_2m_min[i]),
                                    feelsLike: Math.round(data.daily.apparent_temperature_max[i]),
                                    rainProb: data.daily.precipitation_probability_max[i]
                                };
                            }
                        });
                    }
                    const curRes = await fetch('https://api.open-meteo.com/v1/forecast?latitude=13.7563&longitude=100.5018&current=temperature_2m,weather_code&timezone=Asia%2FBangkok');
                    const curData = await curRes.json();
                    if(curData.current) {
                        currentTemp.value = Math.round(curData.current.temperature_2m);
                        weatherCode.value = curData.current.weather_code;
                        weatherLoading.value = false;
                    }
                } catch(e) { weatherLoading.value=false; }
            };

            let map = null;
            let markers = [];
            let myLocationMarker = null;

            const initMap = () => {
                if (!document.getElementById('map')) return;
                if (map) map.remove();
                map = L.map('map', { zoomControl: false }).setView([13.7563, 100.5018], 12);
                
                // Using Google Maps Tiles
                L.tileLayer('http://mt0.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { 
                    attribution: '&copy; Google Maps', 
                    maxZoom: 20 
                }).addTo(map);

                updateMapMarkers();
            };

            const openInGoogleMaps = () => {
                if (!map) return;
                const center = map.getCenter();
                const zoom = map.getZoom();
                window.open(`https://www.google.com/maps/@${center.lat},${center.lng},${zoom}z`, '_blank');
            };

            const updateMapMarkers = () => {
                if (!map) return;
                markers.forEach(m => map.removeLayer(m));
                markers = [];
                const todays = tripData.value[selectedDateIdx.value].items;
                const bounds = L.latLngBounds();
                todays.forEach(item => {
                    if (item.lat && item.lng) {
                        const markerHtml = `<div style="background-color: #E07A5F; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${markers.length + 1}</div>`;
                        const icon = L.divIcon({ className: 'custom-pin', html: markerHtml, iconSize: [24, 24], iconAnchor: [12, 12] });
                        const marker = L.marker([item.lat, item.lng], { icon: icon }).addTo(map).bindPopup(`
                            <div style="text-align:center;">
                                <b>${item.location}</b><br>
                                <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lng}', '_blank')" 
                                style="background:#4285F4; color:white; border:none; padding:4px 8px; border-radius:4px; margin-top:4px; font-size:11px; cursor:pointer;">
                                Google 導航
                                </button>
                            </div>
                        `);
                        markers.push(marker);
                        bounds.extend([item.lat, item.lng]);
                    }
                });
                if (todays.length > 0 && todays.some(i=>i.lat)) map.fitBounds(bounds, { padding: [50, 50] });
            };

            const locateMe = () => {
                if (navigator.geolocation && map) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        const { latitude, longitude } = pos.coords;
                        if (myLocationMarker) map.removeLayer(myLocationMarker);
                        myLocationMarker = L.marker([latitude, longitude]).addTo(map);
                        map.setView([latitude, longitude], 15);
                    });
                }
            };

            const editTitle = () => { const t = prompt('修改旅行標題', tripTitle.value); if(t) tripTitle.value = t; };
            const switchTab = (tab) => currentTab.value = tab;
            const selectDate = (idx) => { currentTab.value = 'schedule'; selectedDateIdx.value = idx; initSortable(); };
            const addDay = () => { tripDays.value++; tripData.value.push({ dayIdx: tripDays.value - 1, items: [] }); };
            
            // Edit Item Logic
            const openAddItemModal = (item = null) => {
                if (item) {
                    isEditing.value = true;
                    newItem.value = JSON.parse(JSON.stringify(item));
                    // Keep the day index for the item being edited, otherwise default to selectedDateIdx
                    targetDateIdx.value = selectedDateIdx.value; // Simplification: assume editing on current view
                } else {
                    isEditing.value = false;
                    newItem.value = { time: '10:00', location: '', category: '景點', note: '', station: '', addressZH: '', addressTH: '' };
                    targetDateIdx.value = selectedDateIdx.value;
                }
                showAddModal.value = true;
            };

            const saveItem = () => {
                if(!newItem.value.location) return;
                
                // Use the target date index selected in modal
                const targetList = tripData.value[targetDateIdx.value].items;
                
                if (isEditing.value) {
                    // Find and update in the currently viewed list (assuming no date change support for simplicity in this edit flow, or advanced: find in all lists)
                    // For robustness, let's look in the current view first.
                    // If we want to support moving days, we'd need to remove from old and add to new.
                    // Simple version: Update in place.
                    const currentList = tripData.value[selectedDateIdx.value].items; 
                    const idx = currentList.findIndex(i => i.id === newItem.value.id);
                    if (idx !== -1) {
                         // If targetDateIdx changed, move it
                         if (targetDateIdx.value !== selectedDateIdx.value) {
                             currentList.splice(idx, 1);
                             targetList.push({ ...newItem.value });
                         } else {
                             currentList[idx] = { ...newItem.value };
                         }
                    }
                } else {
                    // Add new
                    const lat = 13.75 + Math.random() * 0.1; const lng = 100.50 + Math.random() * 0.1;
                    targetList.push({ ...newItem.value, id: Date.now(), lat, lng });
                }
                
                showAddModal.value = false; 
                initSortable();
            };
            const addItem = saveItem; // Alias

            const deleteItem = (id) => { const items = tripData.value[selectedDateIdx.value].items; tripData.value[selectedDateIdx.value].items = items.filter(i => i.id !== id); };
            const navigateTo = (item) => {
                if(item.lat && item.lng) window.open(`https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lng}`, '_blank');
                else window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`, '_blank');
            };
            const getCategoryColor = (cat) => {
                const map = { '景點': 'bg-red-400', '交通': 'bg-blue-400', '航班': 'bg-purple-400', '美食': 'bg-orange-400', '購物': 'bg-pink-400', '住宿': 'bg-green-500', '其他': 'bg-gray-400' };
                return map[cat] || 'bg-gray-400';
            };

            // --- Todo Logic ---
            const openTodoModal = (item = null) => {
                if (item) {
                    isEditingTodo.value = true;
                    newTodo.value = { ...item };
                } else {
                    isEditingTodo.value = false;
                    newTodo.value = { id: null, text: '', category: '行前準備' };
                }
                showTodoModal.value = true;
            };

            const saveTodo = () => {
                if (!newTodo.value.text) return;
                
                if (isEditingTodo.value) {
                    const idx = todoList.value.findIndex(t => t.id === newTodo.value.id);
                    if (idx !== -1) todoList.value[idx] = { ...todoList.value[idx], ...newTodo.value };
                } else {
                    todoList.value.push({ id: Date.now(), text: newTodo.value.text, done: false, category: newTodo.value.category });
                }
                showTodoModal.value = false;
                newTodoText.value = ''; // Clear quick add input if used
            };
            
            // Quick add from bottom input
            const addTodo = () => { 
                if(!newTodoText.value) return; 
                todoList.value.push({ id: Date.now(), text: newTodoText.value, done: false, category: '其他' }); 
                newTodoText.value = ''; 
            };
            const removeTodo = (id) => todoList.value = todoList.value.filter(t => t.id !== id);
            const addShopItem = () => { if(!newShopItem.value) return; shoppingList.value.push({ id: Date.now(), text: newShopItem.value, done: false }); newShopItem.value = ''; };
            
            // --- Expense Logic ---
            const addExpense = () => { 
                if(!newExpense.value.amount) return;
                
                if (isEditingExpense.value) {
                    const idx = expenses.value.findIndex(e => e.id === newExpense.value.id);
                    if (idx !== -1) expenses.value[idx] = { ...newExpense.value };
                } else {
                    expenses.value.push({ 
                        id: Date.now(), 
                        dayIdx: newExpense.value.dayIdx, 
                        ...newExpense.value 
                    }); 
                }
                showExpenseModal.value = false; 
            };
            
            const editExpense = (exp) => {
                isEditingExpense.value = true;
                newExpense.value = { ...exp };
                showExpenseModal.value = true;
            }

            // --- Info / Plan B Logic ---
            const addInfoItem = () => { 
                editingInfo.value = { name: '', addressZH: '', addressTH: '', openHours: '' };
                editingInfoIndex.value = -1; 
                showInfoModal.value = true;
            };
            const editInfoItem = (item, index) => {
                editingInfo.value = { ...item };
                editingInfoIndex.value = index;
                showInfoModal.value = true;
            };
            const saveInfoItem = () => {
                if (editingInfoIndex.value === -1) {
                    infoList.value.push({ ...editingInfo.value });
                } else {
                    infoList.value[editingInfoIndex.value] = { ...editingInfo.value };
                }
                showInfoModal.value = false;
            };

            const addPlanBToSchedule = (info) => {
                // Pre-fill item with Plan B data
                newItem.value = {
                    time: '12:00', // Default time
                    location: info.name,
                    category: '景點',
                    note: info.openHours ? `營業時間: ${info.openHours}` : '',
                    station: '',
                    addressZH: info.addressZH,
                    addressTH: info.addressTH
                };
                isEditing.value = false;
                // Default to adding to Day 2 (11/19) as requested, but let user choose
                targetDateIdx.value = 1; // 11/19 is index 1
                showAddModal.value = true;
            };

            const copyToClipboard = (text) => {
                if (!text) return;
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('已複製：' + text);
                } catch (err) { console.error('Copy failed', err); }
                document.body.removeChild(textArea);
            };

            const sortableList = ref(null);
            const initSortable = () => {
                nextTick(() => {
                    if (sortableList.value) {
                        new Sortable(sortableList.value, {
                            animation: 150, handle: '.group', ghostClass: 'sortable-ghost',
                            onEnd: (evt) => {
                                const arr = tripData.value[selectedDateIdx.value].items;
                                const item = arr.splice(evt.oldIndex, 1)[0];
                                arr.splice(evt.newIndex, 0, item);
                            }
                        });
                    }
                });
            };

            // Watcher to reset expense modal state
            watch(showExpenseModal, (val) => {
                if (val && !isEditingExpense.value) {
                    newExpense.value.dayIdx = selectedDateIdx.value;
                    newExpense.value.title = '';
                    newExpense.value.amount = '';
                    newExpense.value.note = '';
                    newExpense.value.id = null;
                }
                if (!val) isEditingExpense.value = false; // Reset flag on close
            });

            watch(currentTab, (v) => { if(v === 'map') nextTick(initMap); if(v === 'schedule') initSortable(); });
            onMounted(() => { initSortable(); fetchWeather(); });

            return {
                tripTitle, tripDays, currentTab, selectedDateIdx, tripData, todoList, shoppingList, expenses, infoList,
                showAddModal, showShoppingModal, showExpenseModal, showInfoModal, showTodoModal,
                newItem, newTodo, newTodoText, newShopItem, newExpense, categories, targetDateIdx,
                currentDayItems, currentDayWeather, expenseGroups, totalThb, totalTwd, editTitle, switchTab, selectDate, addDay,
                openAddItemModal, addItem, saveItem, deleteItem, navigateTo, getCategoryColor, 
                addTodo, saveTodo, openTodoModal, removeTodo, 
                addShopItem, addExpense, editExpense,
                addInfoItem, editInfoItem, saveInfoItem, editingInfo, copyToClipboard, addPlanBToSchedule,
                locateMe, sortableList, getDayNumber, getDayLabel, getFullDate, getSimpleDate, todoGroups,
                showConverterModal, converterThb, exchangeRate, convertedTwd, weatherLoading, currentTemp, weatherIcon, walletConverterInput, walletConverterResult,
                showMetroMap, openInGoogleMaps, isEditing, mapZoom, isEditingExpense, isEditingTodo
            };
        }
    }).mount('#app');
</script>
</body>
</html>